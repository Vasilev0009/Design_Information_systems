# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # Ð¨Ð°Ð³ 3: Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ JAR-Ñ„Ð°Ð¹Ð» (Ð±ÐµÐ· Ñ‚ÐµÑÑ‚Ð¾Ð²)
      - name: Build JAR file
        run: mvn -B clean package -DskipTests

      # Ð¨Ð°Ð³ 4: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· pom.xml
      - name: Get version from pom.xml
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Found version: ${VERSION}"

      # Ð¨Ð°Ð³ 5: ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ Ð¸Ð¼Ñ JAR Ñ„Ð°Ð¹Ð»Ð°
      - name: Find JAR file
        id: find_jar
        run: |
          JAR_PATH=$(find target -name "*.jar" ! -name "*sources*" ! -name "*javadoc*" | head -1)
          if [ -z "$JAR_PATH" ]; then
            echo "âŒ JAR file not found!"
            ls -la target/
            exit 1
          fi
          echo "JAR_PATH=${JAR_PATH}" >> $GITHUB_OUTPUT
          JAR_NAME=$(basename "$JAR_PATH")
          echo "JAR_NAME=${JAR_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Found JAR: ${JAR_PATH}"

      # Ð¨Ð°Ð³ 6: Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð· Ð½Ð° GitHub
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.LAB }}
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          release_name: Release v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            Ð’Ñ‹Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·
            
            ðŸ“… Ð”Ð°Ñ‚Ð°: $(date +'%Y-%m-%d %H:%M')
            ðŸ”¥ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}
            ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: ${{ github.actor }}

      # Ð¨Ð°Ð³ 7: Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ JAR-Ñ„Ð°Ð¹Ð» Ð² Ñ€ÐµÐ»Ð¸Ð· (Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐ«Ð™)
      - name: Upload JAR to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.LAB }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_jar.outputs.JAR_PATH }}
          asset_name: ${{ steps.find_jar.outputs.JAR_NAME }}
          asset_content_type: application/java-archive

      # Ð¨Ð°Ð³ 8: ÐžÑ‚Ñ‡ÐµÑ‚ Ð² Summary
      - name: Create detailed summary
        run: |
          echo "## ðŸŽ‰ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ð”ÐµÑ‚Ð°Ð»Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð’ÐµÑ€ÑÐ¸Ñ**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¢ÐµÐ³**: v${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JAR-Ñ„Ð°Ð¹Ð»**: ${{ steps.find_jar.outputs.JAR_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¡Ð¾Ð·Ð´Ð°Ð½**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÐÐ²Ñ‚Ð¾Ñ€**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÑÑÑ‹Ð»ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ JAR](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/${{ steps.find_jar.outputs.JAR_NAME }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‹ ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ€ÐµÐ»Ð¸Ð·](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŒ Ð’ÐµÑÑŒ ÐºÐ¾Ð´ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸" >> $GITHUB_STEP_SUMMARY
          echo "1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ JAR-Ñ„Ð°Ð¹Ð» Ð¿Ð¾ ÑÑÑ‹Ð»ÐºÐµ Ð²Ñ‹ÑˆÐµ" >> $GITHUB_STEP_SUMMARY
          echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "3. Ð”Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ€ÐµÐ»Ð¸Ð·Ð° Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² pom.xml" >> $GITHUB_STEP_SUMMARY

    # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive